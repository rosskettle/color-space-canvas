<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>color</title>
        <script type="text/javascript" src="lib/chroma.js"></script>
        <style>

            #controls {
              border:1px solid black;
              width:256px;
              height:80px;
              padding:5px;
            }

            #inputs {
              float:left;
            }

            #color-block {
              width:50px;
              height:50px;
              border:1px solid black;
              float:left;
              margin:5px;
            }

            #color-space {
              display:block;
              width:260px;
            }

            #rect-wrapper, #bar-wrapper {
              position: relative;
            }

            #marker {
              width:10px;
              height:10px;
              -webkit-border-radius:50%;
              -webkit-transform: translate(-5px, -5px);
              border:1px solid red;
              position:absolute;
              left:0px;
              top:0px;
              pointer-events:none;
            }

            #slider {
              width:6px;
              height:20px;

              -webkit-transform: translate(-4px);
              border:1px solid white;
              position:absolute;
              left:0px;
              top:0px;
              pointer-events:none;
            }

            label {
              display: inline-block;
              width:10px;
            }

        </style>

    </head>
    <body>
      <script src="main.js"></script>
      <script src="shaders.js"></script>

      <div id="controls">
        <div id="inputs">
          <label for="c0">H</label>
          <input name="axes" type="radio" value="yz" checked/>
          <input id="c0" name="c0" type="range" value="90" min="0" max="359" step="1"/><br/>

          <label for="c1">S</label>
          <input name="axes" type="radio" value="xz"/>
          <input id="c1" name="c1" type="range" value=".5" min="0" max="1" step=".01"/><br/>

          <label for="c2">V</label>
          <input name="axes" type="radio" value="xy"/>
          <input id="c2" name="c2" type="range" value=".5" min="0" max="1" step=".01"/><br/>
        </div>
        <div id="color-block">
        </div>
      </div>



      <div id="color-space">
        <div id="bar-wrapper">
          <canvas id="bar-canvas" width="256" height="20"></canvas>
          <div id="slider"></div>
        </div>
        <div id="rect-wrapper">
          <canvas id="rect-canvas" width="256" height="256"></canvas>
          <div id="marker"></div>
        </div>


      </div>

      <script>

      var normalizeX = null;
      var normalizeY = null;
      var normalizeZ = null;

      var normalizeHue = function (degrees) {
        return 1 / 360 * degrees;
      }

      var denormalizeHue = function (ratio) {
        return ratio * 360;
      }

      var identity = function(val) {
        return val;
      }

      // ----Model----
      var model = {
        colorValues: [90,.5,.5],
        axes: 'yz',
        normalizeX: normalizeHue
      }



      Array.observe(model.colorValues,function(changes){
        rect.setProps({colorValues: model.colorValues});
        bar.setProps({colorValues: model.colorValues});
        updateColorBlock(model.colorValues);
        input0.value = model.colorValues[0];
        input1.value = model.colorValues[1];
        input2.value = model.colorValues[2];
        updateMarkerPositions();
      })

      Object.observe(model, function(changes) {
        rect.setProps({axes: model.axes})
        if (model.axes == 'yz')
          barAxis = 'x';
        else if (model.axes == 'xz')
          barAxis = 'y';
        else if (model.axes == 'xy')
          barAxis = 'z';
        bar.setProps({axes: barAxis})
        updateMarkerPositions();
      })
      // ------------

      var radios = document.getElementsByName('axes');
      var radioChange = function (e) {
        model.axes = e.target.value;
      }

      radios[0].onchange = radioChange
      radios[1].onchange = radioChange
      radios[2].onchange = radioChange



      var input0 = document.getElementById('c0');
      var input1 = document.getElementById('c1');
      var input2 = document.getElementById('c2');

      var colorBlock = document.getElementById('color-block');

      var rectCanvas = document.getElementById('rect-canvas');
      var barCanvas  = document.getElementById('bar-canvas');
      var marker     = document.getElementById('marker');

      var updateMarkerPositions = function() {
        var x,y,z;
        switch (model.axes) {
          case 'yz' :
            x = 255 * model.colorValues[1]
            y = 255 - 255 * model.colorValues[2]
            z = 255 * model.normalizeX(model.colorValues[0])
            break;
          case 'xz' :
            console.log(model.colorValues[0])
            x = 255 * model.normalizeX(model.colorValues[0])
            y = 255 - 255 * model.colorValues[2]
            z = 255 * model.colorValues[1]
            break;
          case 'xy' :
            x = 255 * model.normalizeX(model.colorValues[0])
            y = 255 -255 * model.colorValues[1]
            z = 255 * model.colorValues[2]
            break;

        }
        setMarkerPosition(x,y);
        setSliderPosition(z);

      }

      var setMarkerPosition = function (x,y) {
        marker.style.left = x + 'px';
        marker.style.top  = y + 'px';
      }

      rectCanvas.onclick = function (e) {
        var x = e.clientX - e.target.offsetParent.offsetLeft;
        var y = e.clientY - e.target.offsetParent.offsetTop;

        switch (model.axes) {
          case 'yz' :
            model.colorValues[1] = 1 / 255 * x;
            model.colorValues[2] = 1 - 1 / 255 * y;
            break;
          case 'xz' :
            model.colorValues[0] = 1 / 255 * x * 360;
            model.colorValues[2] = 1 - 1 / 255 * y;
            break;
          case 'xy' :
            model.colorValues[0] = 1 / 255 * x * 360;
            model.colorValues[1] = 1 - 1 / 255 * y;
            break;

        }
      }

      var setSliderPosition = function (z) {
        slider.style.left = z + 'px';
      }

      barCanvas.onclick = function (e) {
        var x = e.clientX - e.target.offsetParent.offsetLeft;

        switch (model.axes) {
          case 'yz' :
            model.colorValues[0] = (1 / 255 * x) * 360;
            break;
          case 'xz' :
            model.colorValues[1] = (1 / 255 * x);
            break;
          case 'xy' :
            model.colorValues[2] = (1 / 255 * x);
            break;

        }
      }

      var updateColorBlock = function(cols) {
        var rgb = chroma.hsv(cols).rgb()
        cssString = 'rgb(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ')'
        colorBlock.style.backgroundColor = cssString;
      }

      input0.onchange = function(){
        model.colorValues[0] = parseFloat(input0.value)
      }
      input1.onchange = function(){
        model.colorValues[1] = parseFloat(input1.value)
      }
      input2.onchange =  function(){
        model.colorValues[2] = parseFloat(input2.value)
      }

      var bar = new ColorSpaceCanvas({colorSpace:'hsv', colorValues: model.colorValues, axes:'x'}, barCanvas);

      var rect = new ColorSpaceCanvas({colorSpace:'hsv', colorValues: model.colorValues, axes:'yz'}, rectCanvas);

      updateColorBlock(model.colorValues);
      </script>

</body>
</html>
